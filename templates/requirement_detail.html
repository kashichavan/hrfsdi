{% extends 'base.html' %}

{% block title %}{{ requirement.company_name }} - Requirement Details{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap">
<style>
   /* Enhanced Orange & White Theme */
:root {
    --primary: #FF7700;
    --primary-light: #FF9E40;
    --primary-dark: #E66A00;
    --primary-gradient: linear-gradient(145deg, #FF7700, #FF9E40);
    --primary-gradient-hover: linear-gradient(145deg, #FF8819, #FFAB5C);
    --white-gradient: linear-gradient(145deg, #ffffff, #f8f9fa);
    --white-gradient-hover: linear-gradient(145deg, #f8f9fa, #e9ecef);
}

/* Modern font styling - kept the same */
h1, h2, h3, h4, h5, .company-header h1, .card-header {
    font-family: 'Space Grotesk', sans-serif !important;
    font-weight: 600;
}

body, p, table, .btn, .form-control {
    font-family: 'Inter', sans-serif !important;
}
.modal {
    z-index: 1055; /* higher than Bootstrap defaults if necessary */
}

.table-responsive {
    overflow: visible !important;
}
.dropdown-menu {
    z-index: 1055 !important;
}
/* Company header styles - enhanced with gradients */
.company-header {
    background: var(--white-gradient);
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(255, 119, 0, 0.12);
    padding: 2rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    border: 1px solid rgba(255, 119, 0, 0.15);
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.company-header:hover {
    box-shadow: 0 10px 25px rgba(255, 119, 0, 0.18);
    transform: translateY(-2px);
}

.company-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 180px;
    height: 180px;
    background: radial-gradient(circle, rgba(255, 119, 0, 0.15) 0%, rgba(255, 119, 0, 0) 70%);
    border-radius: 50%;
    transform: translate(30%, -30%);
}

.company-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 140px;
    height: 140px;
    background: radial-gradient(circle, rgba(255, 119, 0, 0.08) 0%, rgba(255, 119, 0, 0) 70%);
    border-radius: 50%;
    transform: translate(-20%, 20%);
}

.company-logo {
    width: 80px;
    height: 80px;
    background: var(--primary-gradient);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    box-shadow: 0 10px 15px -3px rgba(255, 119, 0, 0.3);
    transition: all 0.3s ease;
}

.company-logo:hover {
    transform: rotate(5deg);
    box-shadow: 0 12px 20px -5px rgba(255, 119, 0, 0.4);
}

.company-info h1 {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
    color: var(--gray-900);
    background: linear-gradient(90deg, #333333, #555555);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.company-badge {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    background: linear-gradient(145deg, rgba(255, 119, 0, 0.15), rgba(255, 158, 64, 0.15));
    color: var(--primary);
    border-radius: 50px;
    font-weight: 500;
    font-size: 0.875rem;
    margin-right: 0.5rem;
    border: 1px solid rgba(255, 119, 0, 0.25);
    transition: all 0.3s ease;
}

.company-badge:hover {
    background: linear-gradient(145deg, rgba(255, 119, 0, 0.2), rgba(255, 158, 64, 0.2));
}

/* Status badges - enhanced with gradients */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    gap: 0.375rem;
    transition: all 0.2s ease;
}

.status-scheduled {
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.18));
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.status-scheduled:hover {
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.18), rgba(16, 185, 129, 0.24));
}

.status-pending {
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.18));
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.25);
}

.status-pending:hover {
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.18), rgba(245, 158, 11, 0.24));
}

/* Card styling - enhanced with gradients */
.card {
    border-radius: 16px;
    border: 1px solid rgba(255, 119, 0, 0.15);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 30px rgba(255, 119, 0, 0.12);
    transform: translateY(-3px);
}

.card-header {
    background: var(--white-gradient);
    border-bottom: 1px solid rgba(255, 119, 0, 0.1);
    padding: 1.25rem 1.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    color: #444;
    display: flex;
    align-items: center;
}

.card-icon {
    display: inline-flex;
    width: 32px;
    height: 32px;
    background: linear-gradient(145deg, rgba(255, 119, 0, 0.15), rgba(255, 158, 64, 0.15));
    color: var(--primary);
    border-radius: 8px;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    transition: all 0.3s ease;
}

.card:hover .card-icon {
    background: var(--primary-gradient);
    color: white;
    transform: rotate(5deg);
}

/* Button styling - enhanced with gradients */
.btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border-radius: 8px;
    gap: 0.5rem;
    position: relative;
    overflow: hidden;
    z-index: 1;
}

.btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transition: all 0.4s ease;
    z-index: -1;
}

.btn-action:hover::before {
    left: 0;
}

.btn-light {
    background: var(--white-gradient);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
}

.btn-light:hover {
    background: var(--white-gradient-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
}

.btn-warning {
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.25));
    color: #d97706;
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.btn-warning:hover {
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.25), rgba(245, 158, 11, 0.35));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
}

.btn-danger {
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.25));
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.btn-danger:hover {
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.35));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
}

.btn-primary {
    background: var(--primary-gradient);
    color: white;
    border: 1px solid rgba(255, 119, 0, 0.1);
    box-shadow: 0 4px 10px rgba(255, 119, 0, 0.2);
}

.btn-primary:hover {
    background: var(--primary-gradient-hover);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(255, 119, 0, 0.3);
}

.btn-success {
    background: linear-gradient(145deg, #10b981, #059669);
    color: white;
    border: none;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
}

.btn-success:hover {
    background: linear-gradient(145deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
}

/* Schedule date badge - enhanced */
.schedule-date-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.2));
    color: var(--info);
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    gap: 0.5rem;
    border: 1px solid rgba(59, 130, 246, 0.25);
    transition: all 0.3s ease;
}

.schedule-date-badge:hover {
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.25));
    transform: translateY(-2px);
}

/* Student table styling - enhanced */
.student-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.student-table th {
    background: linear-gradient(145deg, #f9fafb, #f3f4f6);
    color: var(--gray-700);
    font-weight: 600;
    padding: 1rem 1.25rem;
    text-align: left;
    font-size: 0.875rem;
    border-bottom: 1px solid var(--gray-200);
}

.student-table td {
    padding: 1rem 1.25rem;
    vertical-align: middle;
    border-bottom: 1px solid var(--gray-200);
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.student-table tbody tr {
    transition: all 0.3s ease;
    background: linear-gradient(145deg, rgba(255, 255, 255, 1), rgba(248, 249, 250, 0.7));
}

.student-table tbody tr:hover {
    background: linear-gradient(145deg, rgba(255, 119, 0, 0.03), rgba(255, 158, 64, 0.05));
    box-shadow: 0 4px 12px rgba(255, 119, 0, 0.07);
    transform: translateX(3px);
}

/* Status select styling - enhanced */
.status-select {
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--gray-300);
    font-size: 0.8125rem;
    background-color: white;
    width: 100%;
    max-width: 130px;
    cursor: pointer;
    transition: all 0.3s ease;
    background-image: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.status-select:hover {
    box-shadow: 0 2px 8px rgba(255, 119, 0, 0.1);
}

.status-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 119, 0, 0.15);
}

/* Status badge for students - enhanced */
.status-badge-student {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.65rem;
    border-radius: 50px;
    font-size: 0.7rem;
    font-weight: 600;
    gap: 0.25rem;
    transition: all 0.2s ease;
}

.status-pending-student {
    background: linear-gradient(145deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.2));
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.25);
}

.status-processing-student {
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.2));
    color: var(--info);
    border: 1px solid rgba(59, 130, 246, 0.25);
}

.status-completed-student {
    background: linear-gradient(145deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2));
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.status-rejected-student {
    background: linear-gradient(145deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2));
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.25);
}

/* Feedback styling - enhanced */
.feedback-view {
    padding: 0.75rem;
    background: linear-gradient(145deg, #fff8f2, #fff4e8);
    border-radius: 8px;
    font-size: 0.8125rem;
    line-height: 1.5;
    border-left: 3px solid var(--primary);
    color: var(--gray-700);
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(255, 119, 0, 0.05);
}

.feedback-view:hover {
    background: linear-gradient(145deg, #fff4e8, #fff0e0);
    border-left: 5px solid var(--primary);
    box-shadow: 0 4px 12px rgba(255, 119, 0, 0.1);
    transform: translateX(2px);
}

.feedback-btn {
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.15));
    color: var(--info);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    font-size: 0.8125rem;
    transition: all 0.3s ease;
}

.feedback-btn:hover {
    background: linear-gradient(145deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.25));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

/* Description styling - enhanced */
.description-content {
    padding: 0.75rem;
    background: linear-gradient(145deg, #f9fafb, #f3f4f6);
    border-radius: 8px;
    font-size: 0.875rem;
    line-height: 1.5;
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
}

.description-content:hover {
    background: linear-gradient(145deg, #f3f4f6, #e9ecef);
    border-color: rgba(255, 119, 0, 0.15);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

/* Info table styling - enhanced */
.info-table {
    width: 100%;
}

.info-table th, .info-table td {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray-200);
    vertical-align: top;
    transition: all 0.2s ease;
}

.info-table th {
    color: var(--gray-700);
    font-weight: 500;
    width: 40%;
    background: linear-gradient(90deg, rgba(255, 119, 0, 0.03), transparent);
    border-radius: 4px 0 0 4px;
    padding-left: 10px;
}

.info-table tr:hover th {
    color: var(--primary);
    background: linear-gradient(90deg, rgba(255, 119, 0, 0.05), transparent);
}

.info-table tr:hover td {
    background-color: rgba(255, 119, 0, 0.02);
}

.info-table tr:last-child th, .info-table tr:last-child td {
    border-bottom: none;
}

/* Modal styling - enhanced */
.modal-content {
    border: none;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    background: var(--white-gradient);
}

.modal-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    background: linear-gradient(145deg, var(--primary), var(--primary-dark));
}

.modal-header .modal-title {
    color: white;
    font-weight: 600;
}

.modal-body {
    padding: 1.5rem;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.modal-footer {
    padding: 1.25rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    background: linear-gradient(145deg, #f8f9fa, #f1f3f5);
}

/* Custom animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.5s ease-out forwards;
}

/* Custom select styling */
.custom-select {
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    color: var(--gray-800);
    font-weight: 500;
    background-color: white;
    background-image: linear-gradient(145deg, #ffffff, #f8f9fa);
    transition: all 0.3s ease;
}

.custom-select:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(255, 119, 0, 0.1);
}

.custom-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 119, 0, 0.15);
    outline: none;
}

/* Form controls - enhanced */
.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    padding: 0.5rem 0.75rem;
    transition: all 0.3s ease;
    background-image: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 119, 0, 0.15);
    outline: none;
}

.form-control:hover, .form-select:hover {
    border-color: var(--primary-light);
}

/* Feedback textarea - enhanced */
.feedback-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 0.875rem;
    resize: vertical;
    transition: all 0.3s ease;
    height: 120px;
    background-image: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.feedback-textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 119, 0, 0.15);
    outline: none;
}

.feedback-textarea:hover {
    border-color: var(--primary-light);
}

/* Dropdown menu styling - enhanced */
.dropdown-menu {
    z-index: 1060 !important;
    animation: fadeIn 0.2s ease-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: none;
    border-radius: 8px;
    padding: 0.5rem;
    position: absolute !important;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
}

.dropdown-item {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: linear-gradient(145deg, rgba(255, 119, 0, 0.1), rgba(255, 158, 64, 0.1));
    color: var(--primary);
}

.dropdown-divider {
    margin: 0.25rem 0;
    border-top: 1px solid rgba(255, 119, 0, 0.1);
}

/* Fix media queries for responsiveness */
@media (max-width: 768px) {
    .company-header {
        flex-direction: column;
        align-items: flex-start;
        padding: 1.5rem;
    }
    
    .company-info {
        margin-bottom: 1rem;
    }
    
    .company-logo {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
}
/* Skill badge styling */
.skill-badge {
        background: linear-gradient(145deg, rgba(255, 119, 0, 0.1), rgba(255, 158, 64, 0.15));
        border: 1px solid rgba(255, 119, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .skill-badge:hover {
        background: linear-gradient(145deg, rgba(255, 119, 0, 0.15), rgba(255, 158, 64, 0.25));
        transform: translateY(-2px);
        box-shadow: 0 3px 6px rgba(255, 119, 0, 0.1);
    }
    
    /* Progress bar animation */
    .progress-bar {
        transition: width 1s ease;
        background-size: 150% 150%;
        animation: gradientAnimation 2s ease infinite;
    }
    
    @keyframes gradientAnimation {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container requirement-container">
    <!-- Company Header -->
    <div class="company-header fade-in">
        <div class="company-logo">
            <i class="fas fa-building"></i>
        </div>
        <div class="company-info flex-grow-1">
            <h1>{{ requirement.company_name }}</h1>
            <div class="d-flex align-items-center gap-2">
                <span class="company-badge">{{ requirement.company_code }}</span>
                {% if requirement.is_scheduled %}
                    <span class="status-badge status-scheduled"><i class="fas fa-calendar-check"></i> Scheduled</span>
                {% else %}
                    <span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex">
            {% if request.META.HTTP_REFERER %}
    <a href="{{ request.META.HTTP_REFERER }}" class="btn btn-light btn-action me-2">
        <i class="fas fa-arrow-left"></i> Back
    </a>
{% else %}
    <a href="{% url 'student_data:requirement_list' %}" class="btn btn-light btn-action me-2">
        <i class="fas fa-arrow-left"></i> Back
    </a>
{% endif %}
            <a href="{% url 'student_data:requirement_edit' requirement.id %}" class="btn btn-warning btn-action me-2">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'student_data:export_requirement_students_excel' requirement.id %}" 
       class="btn btn-success btn-action"
       title="Download Excel of Assigned Students">
        <i class="fas fa-file-excel"></i> Download Excel
    </a>
    <a href="{% url 'student_data:raise_escalation' requirement.id %}" 
   class="btn btn-primary btn-action me-2"
   title="Raise Escalation for this Requirement">
    <i class="fas fa-exclamation-triangle"></i> Raise Escalation
</a>
            <a href="{% url 'student_data:delete_requirement' requirement.id %}" 
               class="btn btn-danger btn-action delete-requirement-btn"
               onclick="return confirm('Are you sure you want to permanently delete this requirement?')">
                <i class="fas fa-trash-can"></i> Delete
            </a>

        </div>
    </div>

    <!-- Requirement Info Card -->
    <div class="card fade-in" style="animation-delay: 0.1s">
        <div class="card-header">
            <div class="d-flex align-items-center">
                <span class="card-icon"><i class="fas fa-info-circle"></i></span>
                Requirement Info
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="info-table">
                        <tr>
                            <th>Created</th>
                            <td>{{ requirement.created_at|date:"M d, Y" }}</td>
                        </tr>
                        <tr>
                            <th>Requirement Date</th>
                            <td>{{ requirement.requirement_date|date:"M d, Y" }}</td>
                        </tr>
                        {% if requirement.is_scheduled %}
                        <tr>
                            <th>Schedule Date</th>
                            <td>
                                <span class="schedule-date-badge">
                                    <i class="fas fa-calendar-alt"></i>
                                    {{ requirement.schedule_date|date:"M d, Y" }}
                                </span>
                            </td>
                        </tr>
                        {% endif %}
                        <!-- Add this in your requirement info card (after the schedule date row) -->
{% if requirement.is_scheduled %}
<tr>
    <th>Drive Result</th>
    <td>
        {% if requirement.scheduled_details %}
            <button type="button" class="btn btn-sm btn-action 
                    {% if requirement.scheduled_details.result == 'pending' %}btn-warning
                    {% elif requirement.scheduled_details.result == 'selected' %}btn-success
                    {% elif requirement.scheduled_details.result == 'no_selects' %}btn-danger
                    {% elif requirement.scheduled_details.result == 'partial_scheduled' %}btn-info
                    {% else %}btn-secondary{% endif %}"
                    data-bs-toggle="modal" data-bs-target="#driveResultModal">
                <i class="fas fa-{% if requirement.scheduled_details.result == 'pending' %}clock
                                {% elif requirement.scheduled_details.result == 'selected' %}check-circle
                                {% elif requirement.scheduled_details.result == 'no_selects' %}times-circle
                                {% elif requirement.scheduled_details.result == 'partial_scheduled' %}users
                                {% else %}calendar{% endif %} me-1"></i>
                {{ requirement.scheduled_details.get_result_display }}
            </button>
        {% else %}
            <button type="button" class="btn btn-sm btn-warning btn-action"
                    data-bs-toggle="modal" data-bs-target="#driveResultModal">
                <i class="fas fa-clock me-1"></i> Set Result
            </button>
        {% endif %}
    </td>
</tr>
{% endif %}
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="info-table">
                        <tr>
                            <th>Status</th>
                            <td>
                                <form id="scheduleStatusForm" method="post" action="{% url 'student_data:update_requirement_schedule' requirement.id %}">
                                    {% csrf_token %}
                                    <select class="custom-select" id="scheduleStatus" name="status" onchange="updateScheduleStatus(this.value)">
                                        <option value="pending" {% if not requirement.is_scheduled %}selected{% endif %}>not scheduled</option>
                                        <option value="scheduled" {% if requirement.is_scheduled %}selected{% endif %}>Scheduled</option>
                                    </select>
                                </form>
                            </td>
                        </tr>
                        {% if requirement.description %}
                        <tr>
                            <th>Description</th>
                            <td>
                                <div class="description-content">{{ requirement.description }}</div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
 
    
<!-- Academic Percentages & Skills Card -->
<div class="card fade-in" style="animation-delay: 0.2s">
    <div class="card-header">
        <div class="d-flex align-items-center">
            <span class="card-icon"><i class="fas fa-graduation-cap"></i></span>
            Academic Requirements & Skills
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Academic Percentages Section -->
            <div class="col-md-6">
                <h5 class="mb-3 fw-semibold"><i class="fas fa-percent text-primary me-2"></i>Academic Percentages</h5>
                <table class="info-table">
                    {% if academic_percentages.10th is not None %}
                    <tr>
                        <th>10th Standard</th>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ academic_percentages.10th }}%; background: var(--primary-gradient);" 
                                     aria-valuenow="{{ academic_percentages.10th }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-primary mt-1">{{ academic_percentages.10th }}%</span>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if academic_percentages.12th is not None %}
                    <tr>
                        <th>12th Standard</th>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ academic_percentages.12th }}%; background: var(--primary-gradient);" 
                                     aria-valuenow="{{ academic_percentages.12th }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-primary mt-1">{{ academic_percentages.12th }}%</span>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if academic_percentages.degree is not None %}
                    <tr>
                        <th>Degree</th>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ academic_percentages.degree }}%; background: var(--primary-gradient);" 
                                     aria-valuenow="{{ academic_percentages.degree }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-primary mt-1">{{ academic_percentages.degree }}%</span>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if academic_percentages.masters is not None %}
                    <tr>
                        <th>Masters</th>
                        <td>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ academic_percentages.masters }}%; background: var(--primary-gradient);" 
                                     aria-valuenow="{{ academic_percentages.masters }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="badge bg-primary mt-1">{{ academic_percentages.masters }}%</span>
                        </td>
                    </tr>
                    {% endif %}
                    
                    {% if not academic_percentages.10th and not academic_percentages.12th and not academic_percentages.degree and not academic_percentages.masters %}
                    <tr>
                        <td colspan="2" class="text-center text-muted py-3">No academic percentage requirements specified</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            
            <!-- Skills Section -->
            <div class="col-md-6">
                <h5 class="mb-3 fw-semibold"><i class="fas fa-tools text-primary me-2"></i>Required Skills</h5>
                <!-- Subjects Section (if you have subjects) -->
                {% if requirement_subjects %}

                <div class="d-flex flex-wrap gap-2">
                    {% for req_subject in requirement_subjects %}
                        <span class="company-badge">
                            <i class="fas fa-book-open me-1"></i>
                            {% if req_subject.custom_name %}
                                {{ req_subject.custom_name }}
                            {% else %}
                                {{ req_subject.subject.name }}
                            {% endif %}
                        </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


    <!-- Students Table Card -->
    <div class="card fade-in" style="animation-delay: 0.3s">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="card-icon"><i class="fas fa-users"></i></span>
                Assigned Students
            </div>
            <a href="{% url 'student_data:add-student-to-requirement' requirement.id %}" class="btn btn-primary btn-sm btn-action">
                <i class="fas fa-plus"></i> Add Students
            </a>
        </div>

        <div class="student-table-container">
            <div class="table-responsive">
                <table class="table table-hover student-table" id="studentsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Degree/Stream</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th>Feedback</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rs in requirement_students %}
                        <tr class="table-row">
                            <td class="fw-medium">{{ rs.student.name }}</td>
                            <td>{{ rs.student.degree }} - {{ rs.student.stream }}</td>
                            <td>{{ rs.student.contact_number }}</td>
                            <td>
                                <select class="status-select" 
                                        onchange="updateStudentStatus(this, '{{ requirement.id }}', '{{ rs.student.id }}')">
                                    <option value="pending" {% if rs.status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="selected" {% if rs.status == 'selected' %}selected{% endif %}>Selected</option>
                                    <option value="rejected" {% if rs.status == 'rejected' %}selected{% endif %}>Rejected</option>
                                </select>
                            </td>
                            <td>
                                {% if rs.feedback %}
                                    <div>
                                        <div class="feedback-view">
                                            {{ rs.feedback }}
                                        </div>
                                        <button type="button" class="btn btn-sm btn-link text-primary mt-2" 
                                                data-bs-toggle="modal" data-bs-target="#feedbackModal"
                                                data-student-id="{{ rs.student.id }}"
                                                data-current-feedback="{{ rs.feedback }}">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </div>
                                {% else %}
                                    <button type="button" class="btn btn-sm feedback-btn" 
                                            data-bs-toggle="modal" data-bs-target="#feedbackModal"
                                            data-student-id="{{ rs.student.id }}"
                                            data-current-feedback="">
                                        <i class="fas fa-comment-dots"></i> Add Feedback
                                    </button>
                                {% endif %}
                            </td>
                            <td>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ rs.student.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ rs.student.id }}">
                                        <li><a class="dropdown-item" href="{% url 'student_data:student_detail' rs.student.id %}"><i class="fas fa-eye me-2"></i> View</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item text-danger remove-student-btn"
                                                    data-student-id="{{ rs.student.id }}"
                                                    data-student-name="{{ rs.student.name }}"
                                                    data-remove-url="{% url 'student_data:remove_student' requirement.id rs.student.id %}">
                                                <i class="fas fa-trash-alt me-2"></i> Remove
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center py-4 text-muted">No students assigned to this requirement yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Remove Student Modal -->
<div class="modal fade" id="removeStudentModal" tabindex="-1" aria-labelledby="removeStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="removeStudentForm" method="post">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="removeStudentModalLabel">Confirm Removal</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                        <p class="mb-0">Are you sure you want to remove <strong id="modalStudentName"></strong> from this requirement?</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i> Remove
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="feedbackForm" method="post" action="{% url 'student_data:update_student_feedback' requirement.id %}">
                {% csrf_token %}
                <input type="hidden" name="student_id" id="feedbackStudentId">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="feedbackModalLabel">
                        <i class="fas fa-comment-dots me-2"></i> Student Feedback
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label">Enter feedback for this student:</label>
                        <textarea class="feedback-textarea" id="feedbackText" name="feedback" rows="4" placeholder="Enter your feedback here..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Save Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Schedule Date Modal -->
<div class="modal fade" id="scheduleDateModal" tabindex="-1" aria-labelledby="scheduleDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="scheduleDateForm" method="post" action="{% url 'student_data:update_requirement_schedule' requirement.id %}">
                {% csrf_token %}
                <input type="hidden" name="status" value="scheduled">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="scheduleDateModalLabel">
                        <i class="fas fa-calendar-alt me-2"></i> Set Schedule Date
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="scheduleDate" class="form-label">Schedule Date:</label>
                        <input type="date" class="form-control" id="scheduleDate" name="schedule_date" 
                               value="{{ requirement.schedule_date|date:'Y-m-d' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Save Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Drive Result Modal -->
<div class="modal fade" id="driveResultModal" tabindex="-1" aria-labelledby="driveResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="driveResultForm" method="post" action="{% url 'student_data:update_drive_result' requirement.id %}">
                {% csrf_token %}
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="driveResultModalLabel">
                        <i class="fas fa-chart-line me-2"></i> Update Drive Result
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="resultStatus" class="form-label">Result:</label>
                        <select class="form-select" id="resultStatus" name="result_status" required>
                            <option value="pending" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'pending' %}selected{% endif %}>Result Pending</option>
                            <option value="selected" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'selected' %}selected{% endif %}>Got Selects</option>
                            <option value="no_selects" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'no_selects' %}selected{% endif %}>No Selects</option>
                            <option value="partial_scheduled" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'partial_scheduled' %}selected{% endif %}>Partial Scheduled</option>
                            <option value="cancelled" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'cancelled' %}selected{% endif %}>Drive Cancelled</option>
                            <option value="postponed" {% if requirement.scheduled_details and requirement.scheduled_details.result == 'postponed' %}selected{% endif %}>Drive Postponed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="driveFeedback" class="form-label">Feedback:</label>
                        <textarea class="form-control" id="driveFeedback" name="feedback" rows="4">{% if requirement.scheduled_details %}{{ requirement.scheduled_details.feedback }}{% endif %}</textarea>
                    </div>
                    <div class="mb-3" id="selectedStudentsContainer">
                        <label class="form-label">Selected Students:</label>
                        <select class="form-select" multiple name="selected_students" id="selectedStudents">
                            {% for student in requirement.students.all %}
                            <option value="{{ student.id }}" 
                                    {% if requirement.scheduled_details and student in requirement.scheduled_details.students_appeared.all %}selected{% endif %}>
                                {{ student.name }} ({{ student.degree }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple students who were selected</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Update Result
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Hidden form for student status updates -->
<form id="statusUpdateForm" method="post" action="{% url 'student_data:update_student_status' requirement_id=0 student_id=0 %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" id="statusUpdateValue" name="status" value="">
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- GSAP Animations ---
    gsap.timeline()
        .from(".company-header", { opacity: 0, y: -20, duration: 0.5, ease: "power3.out" })
        .from(".card", { opacity: 0, y: 20, duration: 0.5, stagger: 0.1, ease: "power3.out" }, "-=0.3");

    const tableRows = document.querySelectorAll(".table-row");
    gsap.set(tableRows, { opacity: 0, y: 15 });
    tableRows.forEach((row, i) => {
        gsap.to(row, {
            opacity: 1,
            y: 0,
            duration: 0.4,
            delay: i * 0.05,
            ease: "power2.out"
        });
    });

    // --- Move Modals to <body> to avoid clipping ---
    ['driveResultModal', 'removeStudentModal', 'feedbackModal', 'scheduleDateModal'].forEach(id => {
        const modalEl = document.getElementById(id);
        if (modalEl) document.body.appendChild(modalEl);
    });

    // --- Result Modal Logic ---
    const driveResultModal = new bootstrap.Modal(document.getElementById('driveResultModal'));
    const resultStatusSelect = document.getElementById('resultStatus');
    const selectedStudentsContainer = document.getElementById('selectedStudentsContainer');

    function toggleStudentSelection() {
        selectedStudentsContainer.style.display = (resultStatusSelect.value === 'selected') ? 'block' : 'none';
    }

    toggleStudentSelection();
    resultStatusSelect.addEventListener('change', toggleStudentSelection);

    document.getElementById('driveResultForm')?.addEventListener('submit', function (e) {
        const resultStatus = resultStatusSelect.value;
        const selectedStudents = document.getElementById('selectedStudents')?.selectedOptions || [];

        if (resultStatus === 'selected' && selectedStudents.length === 0) {
            e.preventDefault();
            showToast('Please select at least one student who was selected', 'warning');
            return;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        submitBtn.disabled = true;
    });

    // --- Remove Student Modal ---
    const removeModal = new bootstrap.Modal(document.getElementById('removeStudentModal'));
    const modalStudentName = document.getElementById("modalStudentName");
    const removeForm = document.getElementById('removeStudentForm');

    document.querySelectorAll(".remove-student-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            modalStudentName.textContent = btn.dataset.studentName;
            removeForm.action = btn.dataset.removeUrl;
            removeModal.show();
        });
    });

    // --- Feedback Modal ---
    const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    const feedbackStudentId = document.getElementById('feedbackStudentId');
    const feedbackText = document.getElementById('feedbackText');

    document.querySelectorAll('[data-bs-target="#feedbackModal"]').forEach(btn => {
        btn.addEventListener('click', function () {
            feedbackStudentId.value = this.dataset.studentId;
            feedbackText.value = this.dataset.currentFeedback || '';
        });
    });

    // --- Schedule Modal ---
    const scheduleStatusForm = document.getElementById('scheduleStatusForm');
    const scheduleDateModal = new bootstrap.Modal(document.getElementById('scheduleDateModal'));
    const scheduleForm = document.getElementById('scheduleDateForm');

    window.updateScheduleStatus = function (value) {
        const statusInput = scheduleStatusForm.querySelector('[name="status"]');
        statusInput.value = value;
        if (value === 'scheduled') {
            scheduleDateModal.show();
        } else {
            scheduleStatusForm.submit();
        }
    };

    if (scheduleForm) {
        scheduleForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const dateInput = this.querySelector('[name="schedule_date"]');

            if (!dateInput.value) {
                showToast('Please select a valid schedule date', 'warning');
                return;
            }

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'schedule_date';
            hiddenInput.value = dateInput.value;
            scheduleStatusForm.appendChild(hiddenInput);
            scheduleStatusForm.submit();
        });
    }

    // --- Status Styling ---
    function styleStatusSelect(select) {
        let color = "#6c757d"; // default
        select.className = 'form-select status-select';

        switch (select.value) {
            case 'pending':
                color = "#ffc107";
                select.classList.add('status-pending-student');
                break;
            case 'selected':
                color = "#28a745";
                select.classList.add('status-completed-student');
                break;
            case 'rejected':
                color = "#dc3545";
                select.classList.add('status-rejected-student');
                break;
        }

        select.style.borderLeft = `4px solid ${color}`;
        select.style.backgroundColor = `${color}10`;
    }

    document.querySelectorAll('.status-select').forEach(select => {
        styleStatusSelect(select);
        select.addEventListener('change', () => styleStatusSelect(select));
    });

    // --- Student Status Update ---
    window.updateStudentStatus = function (select, requirementId, studentId) {
        const form = document.getElementById('statusUpdateForm');
        form.action = `/requirements/${requirementId}/students/${studentId}/update-status/`;
        document.getElementById('statusUpdateValue').value = select.value;
        form.submit();
    };

    // --- Feedback Animation ---
    document.querySelectorAll('.feedback-view').forEach(view => {
        view.addEventListener('mouseenter', () => {
            gsap.to(view, { backgroundColor: "#fff0e0", borderLeftWidth: "5px", duration: 0.3 });
        });
        view.addEventListener('mouseleave', () => {
            gsap.to(view, { backgroundColor: "#fff8f2", borderLeftWidth: "3px", duration: 0.3 });
        });
    });

    // --- DataTables Initialization ---
    if (typeof $.fn.DataTable !== 'undefined' && document.getElementById('studentsTable')) {
        $('#studentsTable').DataTable({
            responsive: true,
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            order: [[0, 'asc']],
            dom: '<"top"lf>rt<"bottom"ip>'
        });
    }

    // --- Skill Badge Animation ---
    gsap.from(document.querySelectorAll('.skill-badge'), {
        opacity: 0,
        y: 10,
        stagger: 0.05,
        duration: 0.4,
        ease: "power2.out",
        delay: 0.5
    });

    // --- Progress Bar Animation ---
    gsap.from(".progress-bar", {
        width: 0,
        duration: 1,
        ease: "power2.out",
        delay: 0.7,
        stagger: 0.1
    });
});
</script>

{% endblock %}
