{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} | Student Management System{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<style>
    /* All CSS styles from previous template */
    .requirement-form-container {
        font-family: 'Inter', sans-serif;
        background-color: #f5f7fa;
    }

    .font-space-grotesk {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
    }

    .main-card {
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        transition: all 0.3s ease;
        border: none;
    }

    .main-card:hover {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .card-header-gradient {
        border-radius: 12px 12px 0 0 !important;
        background: linear-gradient(135deg, #ff6b00 0%, #ff9a56 100%) !important;
        padding: 1.25rem 1.5rem;
        color: white;
    }

    .form-section {
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease;
        margin-bottom: 1.5rem;
    }

    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .section-header {
        background-color: rgba(0, 0, 0, 0.02);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
    }

    .section-header i {
        color: #ff6b00;
        margin-right: 0.5rem;
    }

    .section-body {
        padding: 1.5rem;
    }

    .form-floating-custom > .form-control,
    .form-floating-custom > .form-select {
        height: calc(3.5rem + 2px);
        padding: 1rem 0.75rem;
        border-radius: 8px;
    }

    .form-floating-custom > label {
        padding: 1rem 0.75rem;
    }

    .form-control-custom:focus, 
    .form-select-custom:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 107, 0, 0.25);
        border-color: #ff6b00;
    }

    .toggle-switch-container {
        background-color: #f0f0f0;
        border-radius: 50px;
        padding: 4px;
        display: inline-flex;
        margin-top: 5px;
    }

    .toggle-option {
        margin: 0;
        position: relative;
        z-index: 1;
    }

    .toggle-option input {
        display: none;
    }

    .toggle-option label {
        padding: 8px 16px;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin: 0;
    }

    .toggle-option input:checked + label {
        background-color: white;
        color: #ff6b00;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .checkbox-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
    }

    .checkbox-item {
        position: relative;
        flex: 0 0 calc(33.333% - 15px);
        min-width: 200px;
    }

    .checkbox-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .checkbox-label:hover {
        background-color: #e9ecef;
    }

    .checkbox-item input[type="checkbox"]:checked + .checkbox-label {
        background-color: rgba(255, 107, 0, 0.1);
        border-color: #ff6b00;
        color: #ff6b00;
    }

    .checkbox-item input[type="checkbox"]:checked + .checkbox-label::before {
        content: "âœ“";
        margin-right: 8px;
        font-weight: bold;
    }

    .file-upload-container {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .file-upload-container:hover,
    .file-upload-container.dragover {
        border-color: #ff6b00;
        background-color: rgba(255, 107, 0, 0.05);
    }

    .file-upload-area {
        position: relative;
    }

    .file-upload-area input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        top: 0;
        left: 0;
        cursor: pointer;
    }

    .file-name-display {
        margin-top: 10px;
        font-weight: 500;
        color: #ff6b00;
    }

    .action-buttons-custom {
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
    }

    .btn-custom-primary {
        background: linear-gradient(135deg, #ff6b00 0%, #ff9a56 100%);
        border: none;
        border-radius: 50px;
        padding: 10px 24px;
        transition: all 0.2s ease;
        color: white;
    }

    .btn-custom-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        color: white;
    }

    #otherSubjectContainer {
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px dashed #dee2e6;
        display: none;
    }

    @media (max-width: 768px) {
        .action-buttons-custom {
            flex-direction: column-reverse;
            gap: 1rem;
        }
        
        .action-buttons-custom .btn {
            width: 100%;
        }
        
        .checkbox-item {
            flex: 0 0 100%;
        }
    }

    .academic-criteria-section .section-header {
        background-color: rgba(255, 107, 0, 0.05);
        border-color: rgba(255, 107, 0, 0.15);
    }

    .percentage-input-group {
        position: relative;
    }

    .percentage-symbol {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        pointer-events: none;
        z-index: 4;
    }

    .form-floating-custom .form-control {
        padding-right: 2.5rem;
        border: 1px solid #dee2e6;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-floating-custom .form-control:focus {
        border-color: #ff6b00;
        box-shadow: 0 0 0 0.25rem rgba(255, 107, 0, 0.25);
    }

    .form-floating-custom label {
        color: #6c757d;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-floating-custom .form-control:not(:placeholder-shown) ~ label,
    .form-floating-custom .form-control:focus ~ label {
        color: #ff6b00;
        transform: scale(0.85) translateY(-0.9rem) translateX(0.15rem);
    }

    .invalid-feedback {
        font-size: 0.875rem;
        color: #dc3545;
        padding-left: 0.5rem;
    }

    .form-control.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 1.5rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.375rem) center;
        background-size: calc(0.75em + 0.75rem) calc(0.75em + 0.75rem);
    }

    @media (max-width: 768px) {
        .academic-criteria-section .col-md-3 {
            margin-bottom: 1rem;
        }
        
        .percentage-symbol {
            right: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 requirement-form-container">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg main-card">
                <div class="card-header card-header-gradient">
                    <h4 class="mb-0 font-space-grotesk">{{ title }}</h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="requirementForm">
                        {% csrf_token %}
                        
                        <!-- Company Information -->
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <i class="fas fa-building me-2"></i>
                                <h5 class="font-space-grotesk">Company Information</h5>
                            </div>
                            <div class="section-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-floating form-floating-custom mb-3">
                                            {{ form.company_name }}
                                            <label for="{{ form.company_name.id_for_label }}">{{ form.company_name.label }}</label>
                                            {% if form.company_name.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.company_name.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating form-floating-custom mb-3">
                                            {{ form.company_code }}
                                            <label for="{{ form.company_code.id_for_label }}">{{ form.company_code.label }}</label>
                                            {% if form.company_code.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.company_code.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Information -->
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <h5 class="font-space-grotesk">Schedule Information</h5>
                            </div>
                            <div class="section-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-floating form-floating-custom mb-3">
                                            {{ form.requirement_date }}
                                            <label for="{{ form.requirement_date.id_for_label }}">{{ form.requirement_date.label }}</label>
                                            {% if form.requirement_date.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.requirement_date.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label mb-2">{{ form.is_scheduled.label }}</label>
                                        <div class="toggle-switch-container">
                                            {% for choice in form.is_scheduled %}
                                                <div class="form-check form-check-inline toggle-option">
                                                    {{ choice.tag }}
                                                    <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                        {{ choice.choice_label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="scheduleDateField">
                                        <div class="form-floating form-floating-custom mb-3">
                                            {{ form.schedule_date }}
                                            <label for="{{ form.schedule_date.id_for_label }}">{{ form.schedule_date.label }}</label>
                                            {% if form.schedule_date.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.schedule_date.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <i class="fas fa-align-left me-2"></i>
                                <h5 class="font-space-grotesk">Description</h5>
                            </div>
                            <div class="section-body">
                                <div class="form-floating form-floating-custom mb-3">
                                    {{ form.description }}
                                    <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                                    {% if form.description.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.description.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Subjects -->
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <i class="fas fa-book me-2"></i>
                                <h5 class="font-space-grotesk">Subjects</h5>
                            </div>
                            <div class="section-body">
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label mb-2">{{ form.subjects.label }}</label>
                                        <div class="checkbox-container">
                                            {% for checkbox in form.subjects %}
                                                <div class="checkbox-item">
                                                    {{ checkbox.tag }}
                                                    <label class="checkbox-label" for="{{ checkbox.id_for_label }}">
                                                        {{ checkbox.choice_label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% if form.subjects.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.subjects.errors.0 }}
                                            </div>
                                        {% endif %}
                                        <div id="otherSubjectContainer" class="mt-3">
                                            <div class="form-floating form-floating-custom">
                                                {{ form.other_subject_name }}
                                                <label for="{{ form.other_subject_name.id_for_label }}">{{ form.other_subject_name.label }}</label>
                                                {% if form.other_subject_name.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.other_subject_name.errors.0 }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Criteria -->
                        <div class="form-section mb-4 academic-criteria-section">
                            <div class="section-header">
                                <i class="fas fa-graduation-cap me-2" style="color: #ff6b00;"></i>
                                <h5 class="font-space-grotesk">Academic Criteria</h5>
                            </div>
                            <div class="section-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="form-floating form-floating-custom percentage-input-group">
                                            {{ form.percentage_10th }}
                                            <label for="{{ form.percentage_10th.id_for_label }}">10th Percentage</label>
                                            <span class="percentage-symbol">%</span>
                                            {% if form.percentage_10th.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.percentage_10th.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating form-floating-custom percentage-input-group">
                                            {{ form.percentage_12th }}
                                            <label for="{{ form.percentage_12th.id_for_label }}">12th Percentage</label>
                                            <span class="percentage-symbol">%</span>
                                            {% if form.percentage_12th.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.percentage_12th.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating form-floating-custom percentage-input-group">
                                            {{ form.percentage_degree }}
                                            <label for="{{ form.percentage_degree.id_for_label }}">Degree Percentage</label>
                                            <span class="percentage-symbol">%</span>
                                            {% if form.percentage_degree.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.percentage_degree.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-floating form-floating-custom percentage-input-group">
                                            {{ form.percentage_master }}
                                            <label for="{{ form.percentage_master.id_for_label }}">Master's Percentage</label>
                                            <span class="percentage-symbol">%</span>
                                            {% if form.percentage_master.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.percentage_master.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Upload -->
                        {% if form.student_file %}
                        <div class="form-section mb-4">
                            <div class="section-header">
                                <i class="fas fa-file-excel me-2"></i>
                                <h5 class="font-space-grotesk">Update Student List</h5>
                            </div>
                            <div class="section-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Current file: {{ requirement.student_file.name|default:"No file uploaded" }}
                                        </div>
                                        <div class="file-upload-container" id="fileUploadContainer">
                                            <div class="file-upload-area">
                                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                                <p>Drag & drop Excel file here or</p>
                                                <button type="button" class="btn btn-outline-primary">
                                                    Browse Files
                                                </button>
                                                {{ form.student_file }}
                                                <p class="file-name-display mt-2" id="fileNameDisplay"></p>
                                            </div>
                                            <small class="text-muted d-block mt-2">{{ form.student_file.help_text }}</small>
                                            {% if form.student_file.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.student_file.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="form-floating form-floating-custom mb-3">
                                            {{ form.mobile_column }}
                                            <label for="{{ form.mobile_column.id_for_label }}">{{ form.mobile_column.label }}</label>
                                            {% if form.mobile_column.errors %}
                                                <div class="invalid-feedback">
                                                    {{ form.mobile_column.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4 action-buttons-custom">
                            <a href="{% url 'student_data:requirement_detail' pk=requirement.id %}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-custom-primary">
                                <i class="fas fa-save me-1"></i> Update Requirement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Form loaded successfully');
    
    // Animation
    gsap.from(".form-section", {
        duration: 0.5,
        y: 20,
        opacity: 0,
        stagger: 0.1,
        ease: "power2.out"
    });

    // Schedule Date Toggle
    const isScheduledRadios = document.querySelectorAll('input[name="is_scheduled"]');
    const scheduleDateField = document.getElementById('scheduleDateField');

    function toggleScheduleDate() {
        const isScheduled = document.querySelector('input[name="is_scheduled"]:checked')?.value === 'True';
        if (scheduleDateField) {
            scheduleDateField.style.display = isScheduled ? 'block' : 'none';
            const scheduleInput = document.getElementById('id_schedule_date');
            if (scheduleInput) {
                scheduleInput.required = isScheduled;
            }
        }
    }

    isScheduledRadios.forEach(radio => {
        radio.addEventListener('change', toggleScheduleDate);
    });
    toggleScheduleDate();

    // Other Subject Toggle - Fixed Implementation
    const otherSubjectContainer = document.getElementById('otherSubjectContainer');
    const otherSubjectInput = document.getElementById('id_other_subject_name');
    
    function toggleOtherSubject() {
        // Find the "other" checkbox - it might have different values
        const otherCheckbox = document.querySelector('input[name="subjects"][value="other"]') || 
                             document.querySelector('input[name="subjects"]').closest('form').querySelector('input[value*="Other"]') ||
                             Array.from(document.querySelectorAll('input[name="subjects"]')).find(cb => 
                                 cb.nextElementSibling && cb.nextElementSibling.textContent.toLowerCase().includes('other')
                             );
        
        console.log('Other checkbox found:', otherCheckbox);
        
        if (otherCheckbox && otherSubjectContainer) {
            const isOtherChecked = otherCheckbox.checked;
            console.log('Other checkbox checked:', isOtherChecked);
            
            otherSubjectContainer.style.display = isOtherChecked ? 'block' : 'none';
            
            if (otherSubjectInput) {
                otherSubjectInput.required = isOtherChecked;
                // Clear the field if unchecked
                if (!isOtherChecked) {
                    otherSubjectInput.value = '';
                }
            }
        }
    }

    // Add event listeners to all subject checkboxes
    const subjectCheckboxes = document.querySelectorAll('input[name="subjects"]');
    console.log('Found subject checkboxes:', subjectCheckboxes.length);
    
    subjectCheckboxes.forEach((checkbox, index) => {
        console.log(`Checkbox ${index}:`, checkbox.value, checkbox.nextElementSibling?.textContent);
        checkbox.addEventListener('change', function() {
            console.log('Checkbox changed:', this.value, this.checked);
            toggleOtherSubject();
        });
    });
    
    // Initial toggle on page load
    toggleOtherSubject();

    // Percentage Validation
    const percentageFields = document.querySelectorAll('input[id^="id_percentage_"]');
    percentageFields.forEach(field => {
        field.addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (isNaN(value) || value < 0 || value > 100) {
                this.setCustomValidity('Percentage must be between 0 and 100');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    });

    // File Upload Functionality
    const fileInput = document.getElementById('id_student_file');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileUploadContainer = document.getElementById('fileUploadContainer');

    if (fileInput && fileUploadContainer) {
        // File selection change
        fileInput.addEventListener('change', function() {
            const fileName = this.files[0]?.name || '';
            if (fileNameDisplay) {
                fileNameDisplay.textContent = fileName;
            }
            console.log('File selected:', fileName);
        });

        // Drag and drop functionality
        ['dragenter', 'dragover'].forEach(eventName => {
            fileUploadContainer.addEventListener(eventName, highlight);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileUploadContainer.addEventListener(eventName, unhighlight);
        });

        function highlight(e) {
            e.preventDefault();
            fileUploadContainer.classList.add('dragover');
        }

        function unhighlight(e) {
            e.preventDefault();
            fileUploadContainer.classList.remove('dragover');
            
            if (e.type === 'drop' && e.dataTransfer?.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        }

        // Click to select file
        fileUploadContainer.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT') {
                fileInput.click();
            }
        });
    }

    // Form Validation and Submission
    const requirementForm = document.getElementById('requirementForm');
    if (requirementForm) {
        requirementForm.addEventListener('submit', function(e) {
            console.log('Form submission attempted');
            
            // Add Bootstrap validation classes
            this.classList.add('was-validated');
            
            // Custom validation
            let isValid = true;
            
            // Check if form is valid
            if (!this.checkValidity()) {
                e.preventDefault();
                isValid = false;
                
                // Animate invalid fields
                const invalidFields = document.querySelectorAll(':invalid');
                invalidFields.forEach(field => {
                    gsap.fromTo(field, 
                        { x: -10 }, 
                        { x: 0, duration: 0.3, ease: "elastic.out(1, 0.3)" }
                    );
                });
                
                // Scroll to first invalid field
                const firstInvalid = document.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            }
            
            // Additional custom validations
            const companyName = document.getElementById('id_company_name');
            const companyCode = document.getElementById('id_company_code');
            const requirementDate = document.getElementById('id_requirement_date');
            
            // Company name validation
            if (companyName && companyName.value.trim().length < 2) {
                companyName.setCustomValidity('Company name must be at least 2 characters long');
                companyName.classList.add('is-invalid');
                isValid = false;
            } else if (companyName) {
                companyName.setCustomValidity('');
                companyName.classList.remove('is-invalid');
            }
            
            // Company code validation
            if (companyCode && companyCode.value.trim().length < 2) {
                companyCode.setCustomValidity('Company code must be at least 2 characters long');
                companyCode.classList.add('is-invalid');
                isValid = false;
            } else if (companyCode) {
                companyCode.setCustomValidity('');
                companyCode.classList.remove('is-invalid');
            }
            
            // Date validation - ensure requirement date is not in the past
            if (requirementDate && requirementDate.value) {
                const selectedDate = new Date(requirementDate.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    requirementDate.setCustomValidity('Requirement date cannot be in the past');
                    requirementDate.classList.add('is-invalid');
                    isValid = false;
                } else {
                    requirementDate.setCustomValidity('');
                    requirementDate.classList.remove('is-invalid');
                }
            }
            
            // Schedule date validation
            const isScheduled = document.querySelector('input[name="is_scheduled"]:checked')?.value === 'True';
            const scheduleDate = document.getElementById('id_schedule_date');
            
            if (isScheduled && scheduleDate) {
                if (!scheduleDate.value) {
                    scheduleDate.setCustomValidity('Schedule date is required when scheduled');
                    scheduleDate.classList.add('is-invalid');
                    isValid = false;
                } else {
                    const scheduledDate = new Date(scheduleDate.value);
                    const reqDate = new Date(requirementDate.value);
                    
                    if (scheduledDate <= reqDate) {
                        scheduleDate.setCustomValidity('Schedule date must be after requirement date');
                        scheduleDate.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        scheduleDate.setCustomValidity('');
                        scheduleDate.classList.remove('is-invalid');
                    }
                }
            }
            
            // Subject validation - at least one subject must be selected
            const selectedSubjects = document.querySelectorAll('input[name="subjects"]:checked');
            if (selectedSubjects.length === 0) {
                const subjectsContainer = document.querySelector('.checkbox-container');
                if (subjectsContainer) {
                    // Create or update error message
                    let errorDiv = subjectsContainer.parentNode.querySelector('.subjects-error');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback d-block subjects-error';
                        subjectsContainer.parentNode.appendChild(errorDiv);
                    }
                    errorDiv.textContent = 'Please select at least one subject';
                    isValid = false;
                }
            } else {
                // Remove error message if exists
                const errorDiv = document.querySelector('.subjects-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
            
            // Other subject validation
            const otherCheckbox = Array.from(document.querySelectorAll('input[name="subjects"]')).find(cb => 
                cb.nextElementSibling && cb.nextElementSibling.textContent.toLowerCase().includes('other')
            );
            const otherSubjectInput = document.getElementById('id_other_subject_name');
            
            if (otherCheckbox && otherCheckbox.checked && otherSubjectInput) {
                if (!otherSubjectInput.value.trim()) {
                    otherSubjectInput.setCustomValidity('Please specify the other subject');
                    otherSubjectInput.classList.add('is-invalid');
                    isValid = false;
                } else if (otherSubjectInput.value.trim().length < 2) {
                    otherSubjectInput.setCustomValidity('Subject name must be at least 2 characters long');
                    otherSubjectInput.classList.add('is-invalid');
                    isValid = false;
                } else {
                    otherSubjectInput.setCustomValidity('');
                    otherSubjectInput.classList.remove('is-invalid');
                }
            }
            
            // File validation (if file upload exists)
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const allowedTypes = [
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'text/csv'
                ];
                
                if (!allowedTypes.includes(file.type)) {
                    fileInput.setCustomValidity('Please upload a valid Excel or CSV file');
                    isValid = false;
                } else if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    fileInput.setCustomValidity('File size must be less than 5MB');
                    isValid = false;
                } else {
                    fileInput.setCustomValidity('');
                }
            }
            
            if (!isValid) {
                e.preventDefault();
                console.log('Form validation failed');
                
                // Show error message
                showNotification('Please fix the errors before submitting', 'error');
                
                // Scroll to first error
                const firstError = document.querySelector('.is-invalid, .subjects-error');
                if (firstError) {
                    firstError.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
            } else {
                console.log('Form validation passed, submitting...');
                
                // Show loading state
                const submitBtn = document.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';
                }
            }
        });
    }
    
    // Real-time validation feedback
    const formInputs = document.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
        
        input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid') && this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
    
    // Notification function
    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.custom-notification');
        existingNotifications.forEach(notification => notification.remove());
        
        // Create notification
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} custom-notification position-fixed`;
        notification.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" aria-label="Close"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        gsap.fromTo(notification, 
            { x: 300, opacity: 0 }, 
            { x: 0, opacity: 1, duration: 0.3, ease: "power2.out" }
        );
        
        // Close button functionality
        const closeBtn = notification.querySelector('.btn-close');
        closeBtn.addEventListener('click', () => {
            gsap.to(notification, {
                x: 300,
                opacity: 0,
                duration: 0.3,
                ease: "power2.in",
                onComplete: () => notification.remove()
            });
        });
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                gsap.to(notification, {
                    x: 300,
                    opacity: 0,
                    duration: 0.3,
                    ease: "power2.in",
                    onComplete: () => notification.remove()
                });
            }
        }, 5000);
    }
    
    // Mobile column name suggestions
    const mobileColumnInput = document.getElementById('id_mobile_column');
    if (mobileColumnInput) {
        const commonColumnNames = [
            'mobile', 'phone', 'contact', 'mobile_number', 'phone_number',
            'contact_number', 'Mobile', 'Phone', 'Contact', 'MOBILE', 'PHONE'
        ];
        
        // Create datalist for suggestions
        const datalist = document.createElement('datalist');
        datalist.id = 'mobile-column-suggestions';
        commonColumnNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        });
        
        mobileColumnInput.setAttribute('list', 'mobile-column-suggestions');
        mobileColumnInput.parentNode.appendChild(datalist);
    }
    
    // Initialize tooltips if Bootstrap tooltips are available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Form auto-save functionality (optional)
    let autoSaveTimeout;
    const autoSaveFields = document.querySelectorAll('input:not([type="file"]), select, textarea');
    
    autoSaveFields.forEach(field => {
        field.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // Save form data to localStorage (if needed)
                console.log('Auto-saving form data...');
                // Implementation would depend on requirements
            }, 2000);
        });
    });
    
    console.log('All form functionality initialized successfully');
});

// Additional utility functions
function formatPercentage(input) {
    let value = input.value.replace(/[^\d.]/g, '');
    if (value.includes('.')) {
        const parts = value.split('.');
        if (parts[1].length > 2) {
            value = parts[0] + '.' + parts[1].substring(0, 2);
        }
    }
    input.value = value;
}

// Apply percentage formatting to percentage fields
document.addEventListener('DOMContentLoaded', function() {
    const percentageInputs = document.querySelectorAll('input[id^="id_percentage_"]');
    percentageInputs.forEach(input => {
        input.addEventListener('input', function() {
            formatPercentage(this);
        });
    });
});

</script>
{% endblock %}
